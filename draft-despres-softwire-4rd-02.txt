


Internet Engineering Task Force                               R. Despres
Internet-Draft                                                 RD-IPtech
Intended status: Standards Track                             T. Murakami
Expires: December 18, 2011                                   IP Infusion
                                                           S. Matsushima
                                                                SoftBank
                                                                O. Troan
                                                                   cisco
                                                           June 16, 2011


IPv4 Residual Deployment on IPv6 infrastructure - protocol specification
                     draft-despres-softwire-4rd-02

Abstract

   This document specifies an automatic tunneling mechanism for
   providing IPv4 connectivity service to end users over a service
   provider's IPv6 network.  Key aspects include stateless operation,
   sharing of IPv4 addresses, and an algorithmic mapping between IPv4
   addresses and IPv6 tunnel endpoints.

Status of this Memo

   This Internet-Draft is submitted in full conformance with the
   provisions of BCP 78 and BCP 79.

   Internet-Drafts are working documents of the Internet Engineering
   Task Force (IETF).  Note that other groups may also distribute
   working documents as Internet-Drafts.  The list of current Internet-
   Drafts is at http://datatracker.ietf.org/drafts/current/.

   Internet-Drafts are draft documents valid for a maximum of six months
   and may be updated, replaced, or obsoleted by other documents at any
   time.  It is inappropriate to use Internet-Drafts as reference
   material or to cite them other than as "work in progress."

   This Internet-Draft will expire on December 18, 2011.

Copyright Notice

   Copyright (c) 2011 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to BCP 78 and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (http://trustee.ietf.org/license-info) in effect on the date of
   publication of this document.  Please review these documents



Despres, et al.         Expires December 18, 2011               [Page 1]

Internet-Draft          IPv4 Residual Deployment               June 2011


   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.


Table of Contents

   1.  Introduction . . . . . . . . . . . . . . . . . . . . . . . . .  3
   2.  Requirements Language  . . . . . . . . . . . . . . . . . . . .  4
   3.  Terminology  . . . . . . . . . . . . . . . . . . . . . . . . .  4
   4.  Protocol Specification . . . . . . . . . . . . . . . . . . . .  5
     4.1.  Mapping-Rule Parameters  . . . . . . . . . . . . . . . . .  5
     4.2.  Mapping Rules  . . . . . . . . . . . . . . . . . . . . . .  6
       4.2.1.  From a CE IPv6 Prefix to a CE 4rd Prefix . . . . . . .  6
       4.2.2.  From a CE 4rd Prefix to a Port-set ID  . . . . . . . .  6
       4.2.3.  From a Port-Set ID to a Port Set . . . . . . . . . . .  7
       4.2.4.  From an IPv4 Address or IPv4 Address + Port to a
               CE IPv6 Address  . . . . . . . . . . . . . . . . . . .  9
     4.3.  Encapsulation and Fragmentation Consideration  . . . . . . 10
     4.4.  BR and CE behaviors  . . . . . . . . . . . . . . . . . . . 11
       4.4.1.  Domains having only One Mapping rule . . . . . . . . . 11
       4.4.2.  ICMP . . . . . . . . . . . . . . . . . . . . . . . . . 12
   5.  4rd Configuration  . . . . . . . . . . . . . . . . . . . . . . 12
   6.  Security Considerations  . . . . . . . . . . . . . . . . . . . 13
   7.  IANA Consideration . . . . . . . . . . . . . . . . . . . . . . 13
   8.  Acknowledgements . . . . . . . . . . . . . . . . . . . . . . . 14
   9.  TODO . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 14
   10. References . . . . . . . . . . . . . . . . . . . . . . . . . . 14
     10.1. Normative References . . . . . . . . . . . . . . . . . . . 14
     10.2. Informative References . . . . . . . . . . . . . . . . . . 14
   Authors' Addresses . . . . . . . . . . . . . . . . . . . . . . . . 15


















Despres, et al.         Expires December 18, 2011               [Page 2]

Internet-Draft          IPv4 Residual Deployment               June 2011


1.  Introduction

   4rd is a protocol mechanism to deploy IPv4 to sites via a service
   provider's (SP's) IPv6 network.  Similar to Dual-Stack Lite
   [I-D.ietf-softwire-dual-stack-lite], 4rd is designed to allow IPv4
   traffic to be delivered over an IPv6 network without the direct
   provisioning of IPv4 addresses. 4rd can provide an IPv4 prefix, an
   IPv4 address or a shared IPv4 address to end users.  Like 6rd
   [RFC5969], 4rd is operated in a fully stateless manner within the SP
   network.  The motivation for a stateless alternative to Dual-Stack
   Lite is described in "Motivations for Stateless IPv4 over IPv6
   Migration Solutions"
   [I-D.operators-softwire-stateless-4v6-motivation]. 4rd relies on IPv6
   and is designed to deliver production-quality dual-stack service
   while allowing IPv4 to be phased out within the SP network.  The
   phasing out of IPv4 within the SP network is independent of whether
   the end user disables IPv4 service or not.  Further, "Greenfield"
   IPv6-only networks may use 4rd in order to deliver IPv4 to sites via
   the IPv6 network in a way that does not require protocol translation
   between IPv4 and IPv6.

   4rd utilizes an algorithmic mapping between the IPv6 and IPv4
   addresses that are assigned for use within the SP network.  This
   mapping provides automatic determination of IPv6 tunnel endpoints
   from IPv4 destination addresses, allowing the stateless operation of
   4rd. 4rd views the IPv6 network as a link layer for IPv4 and supports
   an automatic tunneling abstraction similar to the Non-Broadcast
   Multiple Access (NBMA) [RFC2491] model.

   A 4rd domain consists of 4rd Customer Edge (CE) routers and one or
   more 4rd Border Relays (BRs).  IPv4 packets encapsulated by 4rd
   follow the IPv6 routing topology within the SP network between CEs
   and among CEs and BRs.  CE to CE traffic is direct, while BRs are
   traversed only for IPv4 packets that are destined to or are arriving
   from outside a given 4rd domain.  As 4rd is stateless, BRs may be
   reached using anycast for failover and resiliency.

   On the "end-user-facing" (i.e., "LAN") side of a CE, IPv6 and IPv4
   are implemented as for any native dual-stack service delivered by the
   SP.  On the "SP-facing" (i.e., "WAN") side of the 4rd CE,
   provisioning of the interface itself, IPv6 and datalink
   encapsulation, as well as control protocols such as IPv6 Neighbor
   Discovery, DHCPv6, etc. all operate as native IPv6 with no need for
   IPv4 operation or support.

   4rd does not require any stateful NAPT [RFC3022] functions at the BRs
   or elsewhere within the SP network.  Instead, 4rd allows for sharing
   of IPv4 addresses among multiple sites by automatically allocating a



Despres, et al.         Expires December 18, 2011               [Page 3]

Internet-Draft          IPv4 Residual Deployment               June 2011


   set of non-overlapping ports for each CE as part of the stateless
   mapping function.  It is expected that the CE will, in turn, perform
   local IPv4 Network Address and Port Translation (NAPT) [RFC3022]
   functions for the site as is commonly performed today, except
   avoiding ports outside of the allocated port set.  Although 4rd is
   designed primarily to support IPv4 deployment to a customer site
   (such as a residential home network) by an SP, it can equally be
   applied to an individual host acting as a CE router.


2.  Requirements Language

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in RFC 2119 [RFC2119].


3.  Terminology

   4rd domain (Domain):  an IPv6 routing network operated by an ISP and
                         comprising one or several 4rd BR's having the
                         same set of parameters.  It offers to its 4rd-
                         capable CE's global IPv4 connectivity, both
                         outgoing and incoming, and with exclusive or
                         shared IPv4 addresses.

   4rd Border Relay (BR):  A 4rd-capable router managed by the service
                         provider at the edge of a 4rd domain.  A BR has
                         an IPv6-enabled interface connected to the ISP
                         network, and an IPv4 virtual interface acting
                         as an endpoint for the automatic 4rd tunnel.
                         This tunnel (IPv4 in IPv6) is between the BR
                         and all CE's of the Domain.

   4rd Customer Edge (CE):  A node at the border between a customer
                         network and the 4rd domain.  This node has an
                         IPv6 interface connected to the ISP network,
                         and a virtual IPv4 interface acting as the end-
                         point of the automatic 4rd tunnel.  This tunnel
                         (IPv4 in IPv6) is between the CE and all other
                         CE's and all BR's of the Domain.  It may be a
                         host, a router, or both.

   CE IPv6 prefix:       The IPv6 prefix assigned to a CE by other means
                         than 4rd itself, and used by 4rd to derive a CE
                         4rd prefix.





Despres, et al.         Expires December 18, 2011               [Page 4]

Internet-Draft          IPv4 Residual Deployment               June 2011


   CE IPv6 address:      In the context of 4rd, the IPv6 address used to
                         reach a CE from other CE's and from BR's.  A CE
                         typically has another IPv6 address, assigned to
                         it at its IPv6 interface without relationship
                         with 6rd.

   CE 4rd prefix:        The 4rd prefix of the CE.  It is derived from
                         the CE IPv6 prefix by a mapping rule according
                         to Section 4.2.  Depending on its length, it is
                         an IPv4 prefix, an IPv4 address, or a shared
                         IPv4 address followed by a Port-set ID
                         (Section 4.2.2).

   Port-set ID:          In a CE 4rd prefix longer than 32 bits, bits
                         that follow the first 32.  It algorithmically
                         identifies a set of ports exclusively assigned
                         to the CE.  As specified in Section 4.3.3, the
                         set can comprise up to 4 disjoint port ranges.

   Domain IPv6 prefix:   An IPv6 prefix assigned by an ISP to a 4rd
                         domain.

   Domain IPv4 prefix:   A 4rd prefix assigned by an ISP to the 4rd
                         domain.  In typical operator applications, it
                         is an IPv4 prefix.  In a residential site in
                         which an already shared IPv4 address has to be
                         shared even more among several hosts, it may
                         have more than 32 bits.

   IPv4 EA-bits:         IPv4 Embedded Address bits embedded in the IPv6
                         address identifying an IPv4 prefix, IPv4
                         address or part of IPv4 address and port set.


4.  Protocol Specification

4.1.  Mapping-Rule Parameters

   Both CE's and BR's have to know the BR IPv6 address of their domain
   as well as, for each mapping rule, the following parameters:

   o  Domain IPv6 prefix

   o  Domain 4rd prefix

   o  IPv6 prefix length





Despres, et al.         Expires December 18, 2011               [Page 5]

Internet-Draft          IPv4 Residual Deployment               June 2011


   o  Domain IPv6 suffix (optional - default ::/0)

4.2.  Mapping Rules

4.2.1.  From a CE IPv6 Prefix to a CE 4rd Prefix

   A 4rd mapping rule establishes a 1:1 mapping between CE IPv6 prefixes
   and CE 4rd prefixes.


         <---------------- CE IPv6 prefix (max 128) -------------->
         +-------------------------------+------------------------+
         |      Domain IPv6 prefix       |        EA bits         |
         +-------------------------------+------------------------+
         <-- Domain IPv6 Prefix length ->:<--  EA bit length  --->:
                                         :                        :
                                         :         ||             :
                                         :         \/             :
                                         :                        :
                                         :<--  EA bit length  --->:
                     +-------------------+------------------------+
                     | Domain 4rd prefix |        EA bits         |
                     +-------------------+------------------------+
                     <----------- CE 4rd prefix (max 47) --------->

            Figure 1: From a CE IPv6 Prefix to a CE 4rd Prefix

   A CE derives its CE 4rd prefix from the IPv6 prefix it has been
   delegated on the IPv6 network, using for this parameters of the
   applicable mapping rule.  If the domain has several mapping rules,
   that which applies is that whose Domain IPv6 prefix is at the
   beginning of the CE IPv6 prefix.  As shown in Figure 1, the CE 4rd
   prefix is made of the Domain 4rd prefix followed by the IPv4 EA bits,
   where the IPv4 EA bits is the remainder of the CE IPv6 prefix after
   the Domain IPv6 prefix (the length of the Domain IPv6 prefix is
   defined by the mapping rule).

4.2.2.  From a CE 4rd Prefix to a Port-set ID

   Depending on its length, a CE 4rd prefix is either an IPv4 prefix, a
   full IPv4 address, or a shared IPv4 address followed by a Port-set ID
   (Figure 2).  If it includes a port set ID, this ID specifies which
   ports are assigned to the the CE for its exclusive use
   (Section 4.2.3).







Despres, et al.         Expires December 18, 2011               [Page 6]

Internet-Draft          IPv4 Residual Deployment               June 2011


                          <-- CE 4rd prefix length -->
                          +--------------------------+- - -+
     Shorter than 32 bits |       IPv4 prefix        | ... |
                          + -------------------------+- - -+
                          <--------------- 32 ------------->


                          <----- CE 4rd prefix length ----->
                          +--------------------------------+
           32 bits        |          IPv4 address          |
                          +--------------------------------+
                          <--------------- 32 ------------->


                          <----------- CE 4rd prefix length ---------->
                          +-------------------------------+-----------+
         33 to 47 bits    |      IPv4 shared address      |Port-set ID|
                          +-------------------------------+-----------+
                          <--------------- 32 -----------><- max 15 -->

                   Figure 2: Variants of CE 4rd prefixes

4.2.3.  From a Port-Set ID to a Port Set

   Each value of a Port-set ID specifies which ports can be used by any
   protocol whose header format starts with source and destination ports
   (UDP, TCP, SCTP, etc.).  Design constraint of the algorithm are the
   following:

   Fairness with respect to special-value ports:  No port-set must
                         contain any port from 0 to 4095.  (These ports,
                         which have more value than others in OS's, are
                         normally not used in dynamic port assignments
                         to applications).

   Fairness with respect to the number of ports  For a Port-set-ID's
                         having the same length, all sets must have the
                         same number of ports.

   Exhaustiveness        For any Port-set-ID length, the aggregate of
                         port sets assigned for all values must include
                         all ordinary-value ports (from 4,096 to
                         65,535).

   If the Port-set ID has 1 to 12 bits, the set comprises 4 port ranges.
   As shown in Figure 3, each port range is defined by its port prefix,
   made of a range-specific "head" followed by the Port-set ID.  Head
   values are in binary 1, 01, 001, and 0001.  They are chosen to



Despres, et al.         Expires December 18, 2011               [Page 7]

Internet-Draft          IPv4 Residual Deployment               June 2011


   exclude ports 0-4095 and only them.


                   <------- Port (16 bits) -------->
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   Port-range a    |1|x x x x x x x x|             |  0xF780 - 0xF7FF
    (head = 1)     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                      \               \
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   Port-range b    |0 1|x x x x x x x x|           |  0x7BC0 - 0x7BFF
    (head = 01)    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                        \               \
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   Port-range c    |0 0 1|x x x x x x x x|         |  0x3DE0 - 0x3DFF
    (head = 001)   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                          \               \
                   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   Port-range d    |0 0 0 1|x x x x x x x x|       |  0x1EF0 - 0x1EFF
    (head = 0001)  +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
                   <- head-><--Port-set ID->                 /\
                   <-- Port-range prefix --><-tail->         ||
                                                             ||
                                                Example of Port-ranges
                                              if the Port-set ID is 0xEF

                 Figure 3: From Port-set ID to Port ranges

   In the Port-set ID has 13 bits, only the 3 port ranges are assigned,
   having heads 1, 01, and 001.  If it has 14 bits, only the 2 port
   ranges having heads 1 and 01 are assigned.  If it has 15 bits, only
   the port range having head 1 is assigned.  (In these three cases, the
   smallest port range has only one element).

   NOTE: The port set assigned to a CE may be further subdivided by the
   CE among several functions such as the following: (1) an IPv4 NAPT
   (possibly configurable to do port forwarding, and possibly doing
   dynamic port assignments to hosts with UPnP and/or NAT-PMP); (2) an
   API for applications in the CE that need dynamic port assignments;
   (3) a new 4rd BR which assigns to its CE's subsets of its own port
   set.  How to chose among these functions and/or combine them is
   beyond the scope of this specification.  Readers are referred to
   documents dealing with operational applicability in diverse
   environments, e.g. [draft-sun-intarea-4rd-applicability] prepared in
   parallel of this one.







Despres, et al.         Expires December 18, 2011               [Page 8]

Internet-Draft          IPv4 Residual Deployment               June 2011


4.2.4.  From an IPv4 Address or IPv4 Address + Port to a CE IPv6 Address


                       Port-set ID
                            |
      <--- CE 4rd prefix ---|->
      +---------------+---+-|--+
      |IPv4 shared address| '  |
      +---------------+---+----+
                      <-------->
                    CE-index length
                      :        :
                      :   ||   :
                      :   ||   :
                      :   \/   : Domain IPv6 suffix
                      :        :  |
   +------------------+--------+--|-+----------------------------------+
   |Domain IPv6 prefix| EA bits|  ' |                  0               |
   +------------------+--------+----+----------------------------------+
   <------------ max 64 ------------>
   <---------------------- CE IPv6 address (128) --------------------->

   Figure 4: From 4rd Prefix to IPv6 address (shared IPv4 address case)

   In order to find whether a CE IPv6 address can be derived from an
   IPv4 address, or an IPv6 address + a port, a mapping rule has to be
   found that matches the IPv4 information:

   o  If a mapping rule has a length L of CE IPv4 prefixes which does
      not exceed 32 bits, there is a match if the IPv4 address starts
      with the Domain 4rd prefix.  The CE 4rd prefix is then the first L
      bits of the IPv4 address.

   o  If a mapping rule has a length L of CE IPv4 prefixes which exceeds
      32 bits, the match can only be found with the IPv4 address and the
      port.  For this, the port is examined to determine which port-
      range head it starts with: 1, 01,001, or 0001.  The N bits that
      follow this head are taken as Port-set ID, where N is the length
      of Port set ID of the mapping rule.  The CE 4rd prefix is then
      made of the IPv4 address followed by the Port-set ID.

   If a match has been found, the CE IPv6 prefix is then made of the
   Domain IPv6 prefix followed by bits of the CE 4rd prefix that follow
   the Domain 4rd prefix, followed by the Domain IPv6 prefix of the
   mapping rule if there is one, and followed by 0's up to 128 bits to
   make a complete IPv6 address ([RFC4291].  Figure 4 illustrates this
   process in the case of a shared IPv4 address.




Despres, et al.         Expires December 18, 2011               [Page 9]

Internet-Draft          IPv4 Residual Deployment               June 2011


4.3.  Encapsulation and Fragmentation Consideration

   Maximum transmission unit (MTU) and fragmentation issues for IPv6 in
   IPv4 tunneling are discussed in detail in Section 3.2 of RFC 4213
   [RFC4213]. 6rd's scope is limited to a service provider network.
   IPv4 Path MTU discovery MAY be used to adjust the MTU of the tunnel
   as described in Section 3.2.2 of RFC 4213 [RFC4213], or the 6rd
   Tunnel MTU might be explicitly configured.

   The use of an anycast source address could lead to any ICMP error
   message generated on the path being sent to a different BR.
   Therefore, using dynamic tunnel MTU Section 3.2.2 of [RFC4213] is
   subject to IPv4 Path MTU blackholes.

   Multiple BRs using the same anycast source address could send
   fragmented packets to the same IPv6 CE at the same time.  If the
   fragmented packets from different BRs happen to use the same fragment
   ID, incorrect reassembly might occur.  For this reason, a BR using an
   anycast source address MUST set the IPv4 Don't Fragment flag.

   If the MTU is well-managed such that the IPv4 MTU on the CE WAN side
   interface is set so that no fragmentation occurs within the boundary
   of the SP, then the 6rd Tunnel MTU should be set to the known IPv4
   MTU minus the size of the encapsulating IPv4 header (20 bytes).  For
   example, if the IPv4 MTU is known to be 1500 bytes, the 6rd Tunnel
   MTU might be set to 1480 bytes.  Absent more specific information,
   the 6rd Tunnel MTU SHOULD default to 1280 bytes.

   For 4rd domain traversal, IPv4 packets are encapsulated in IPv6
   packets whose Next header is set to 4 (i.e.  IPv4).  If fragmentation
   of IPv6 packets is needed, it is performed according to [RFC2460],
   and as illustrated in [deleted].  Absent more specific information,
   the path MTU of a 4rd Domain has to be set to 1280 [RFC2460].

   In domains where IPv4 addresses are not shared, IPv6 destinations are
   derived from IPv4 addresses alone.  Thus, each IPv4 packet can be
   encapsulated and decapsulated independently of each other. 4rd
   processing is completely stateless.

   On the other hand, in domains where IPv4 addresses are shared, BR's
   and CE's can have to encapsulate IPv4 packets whose IPv6 destinations
   depend on destination ports.  Precautions are needed, due to the fact
   that the destination port of a fragmented datagram is available only
   in its first fragment.  A sufficient precaution consists in
   reassembling each datagram received in multiple packets, and to treat
   it as though it would have been received in single packet.  This
   function is such that 4rd is in this case stateful at the IP layer.
   (This is common with DS-lite and NAT64/DNS64 which, in addition, are



Despres, et al.         Expires December 18, 2011              [Page 10]

Internet-Draft          IPv4 Residual Deployment               June 2011


   stateful at the transport layer.)  At Domain entrance, this ensures
   that all pieces of all received IPv4 datagrams go to the right IPv6
   destinations.

   Another peculiarity of shared IPv4 addresses is that, without
   precaution, a destination could simultaneously receive from different
   sources fragmented datagrams that have the same Datagram ID (the
   Identification field of [RFC0791].  This would disturb the reassembly
   process.  To eliminate this risk, BR's and CE's SHOULD, in datagrams
   they receive from shared-IPv4-address CE's, replace received Datagram
   ID's by new ones.  New values SHOULD be generated as though these
   datagrams would have been created locally (and with due respect of
   [RFC0791]).  Note that replacing a Datagram ID in an IPv4 header
   implies an update of its Header-checksum field, by adding to it the
   one's complement difference between the old and the new values.

4.4.  BR and CE behaviors

4.4.1.  Domains having only One Mapping rule

   (a) BR reception of an IPv4 packet

   Step 1                If the length of CE 4rd prefixes does not
                         exceed 32 bits, the BR proceeds to step 2.
                         Otherwise, and unless the packet contains a
                         complete IPv4 datagram, IPv4 datagram
                         reassembly is performed.  If a complete
                         datagram is available, the BR proceeds to step
                         2 as though the datagram had been received in a
                         single packet.

   Step 2                The BR checks that the IPv4 source doesn't
                         start with the Domain 4rd prefix, and that a CE
                         IPv6 address is successfully derived from the
                         IPv4 destination.  In case of success, the
                         packet is encapsulated and forwarded to this CE
                         IPv6 address via the IPv6 interface.

   (b) BR reception of an IPv6 packet

   Step 1                The BR checks that a CE IPv6 address is
                         successfully derived from the source of the
                         IPv4 encapsulated packet, and that the source
                         address of the encapsulating packet is equal to
                         it.  In case of success: (1) if the length of
                         CE 4rd prefixes exceeds 32 bits, the Datagram
                         ID of the packet is replaced by a locally
                         generated one; (2) the IPv4 packet is forwarded



Despres, et al.         Expires December 18, 2011              [Page 11]

Internet-Draft          IPv4 Residual Deployment               June 2011


                         via the IPv4 interface.

   (c) CE reception of an IPv4 packet

   Step 1                If the CE 4rd prefix of the CE does not exceed
                         32 bits and the IPv4 destination address starts
                         with the Domain 4rd prefix, the CE proceeds to
                         step 2.  Otherwise, and unless the packet
                         contains a complete IPv4 datagram, IPv4
                         datagram reassembly is performed.  If a
                         complete datagram is available, the BR proceeds
                         to step 2 as though the datagram had been
                         received in a single packet.

   Step 2                The CE tries tries to derive a CE IPv6 address
                         from the IPv4 destination.  It then
                         encapsulates the IPv4 packet into an IPv6
                         packet whose destination is this CE IPv6
                         address, if one is obtained, or the BR IPv6
                         address otherwise.

   (d) CE reception of an IPv6 packet

   Step 1                The CE checks that a CE IPv6 address is
                         successfully derived from the source of the
                         IPv4 encapsulated packet, AND that it is equal
                         to the source address of the encapsulating
                         packet.  In case of success: (1) if the length
                         of CE 4rd prefixes exceeds 32 bits, the
                         Datagram ID of the packet is replaced by a
                         locally generated one; (2) the IPv4 packet is
                         forwarded via the IPv4 interface.

4.4.2.  ICMP


5.  4rd Configuration

   A CE can acquire 4rd parameters of its 4rd domain in various ways:
   manual configuration by an administrator, software download by the
   ISP, a new DHCPv6 option, etc.  A companion document [ref] describes
   how to configure the necessary parameters via DHCPv6 [RFC3315].  A CE
   that allows IPv6 configuration by DHCPv6 SHOULD implement this
   option.  Other configuration and management methods, MAY use the
   format described by this option for consistency and convenience of
   implementation on CEs that support multiple configuration methods.





Despres, et al.         Expires December 18, 2011              [Page 12]

Internet-Draft          IPv4 Residual Deployment               June 2011


6.  Security Considerations

   Spoofing attacks      With consistency checks between IPv4 and IPv6
                         sources that are performed on IPv4/IPv6 packets
                         received by BR's and CE's (Section 4.4), 4rd
                         does not introduce any opportunity for spoofing
                         attack that would not pre-exist in IPv6.

   Denial-of-service attacks  In 4rd domains where IPv4 addresses are
                         shared, the fact that IPv4 datagram reassembly
                         may be necessary introduces an opportunity for
                         DOS attacks (Section 4.4).  This is inherent to
                         address sharing, and is common with other
                         address sharing approaches such as DS- lite and
                         NAT64/DNS64.  The best protection against such
                         attacks is to accelerate IPv6 enablement in
                         both clients and servers so that, where 4rd is
                         supported, it is less and less used.

   Routing-loop attacks  Routing-loop attacks that may exist in some
                         automatic-tunneling scenarios are documented in
                         [I-D.ietf-v6ops-tunnel-loops].  They cannot
                         exist with 4rd because each BRs checks that the
                         IPv6 source address of a received IPv6 packet
                         is a CE address (Section 4.4.1 (b) and (b)).

   Attacks facilitated by restricted port sets  From hosts that are not
                         subject to ingress filtering of [RFC2827], some
                         attacks are possible by intervening with faked
                         packets during ongoing transport connections
                         ([RFC4953], [RFC5961], [RFC6056].  These
                         attacks, that have mitigations of their own are
                         easier with hosts that only use restricted port
                         sets (they depend on guessing which ports are
                         currently used by target hosts).  To avoid
                         using restricted port sets, the easiest
                         approach consists in increasing the proportion
                         of connections that are IPv6, i.e. using
                         unrestricted port sets.


7.  IANA Consideration

   This document makes no request of IANA.







Despres, et al.         Expires December 18, 2011              [Page 13]

Internet-Draft          IPv4 Residual Deployment               June 2011


8.  Acknowledgements

   The authors wish to thank Mark Townsley for his active encouragements
   to pursue the 4rd approach since it was first introduced in
   [I-D.despres-softwire-sam].  Questions raised by Wojciech Dec have
   been useful to clarify explanations.  Olivier Vautrin, who
   independently proposed a similar approach with the same acronym
   deserves special recognition.


9.  TODO

   CE NATs


10.  References

10.1.  Normative References

   [RFC0791]  Postel, J., "Internet Protocol", STD 5, RFC 791,
              September 1981.

   [RFC2119]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", BCP 14, RFC 2119, March 1997.

   [RFC2460]  Deering, S. and R. Hinden, "Internet Protocol, Version 6
              (IPv6) Specification", RFC 2460, December 1998.

   [RFC3315]  Droms, R., Bound, J., Volz, B., Lemon, T., Perkins, C.,
              and M. Carney, "Dynamic Host Configuration Protocol for
              IPv6 (DHCPv6)", RFC 3315, July 2003.

   [RFC4291]  Hinden, R. and S. Deering, "IP Version 6 Addressing
              Architecture", RFC 4291, February 2006.

10.2.  Informative References

   [I-D.despres-softwire-sam]
              Despres, R., "Stateless Address Mapping (SAM) - a
              Simplified Mesh-Softwire Model",
              draft-despres-softwire-sam-01 (work in progress),
              July 2010.

   [I-D.ietf-softwire-dual-stack-lite]
              Durand, A., Droms, R., Woodyatt, J., and Y. Lee, "Dual-
              Stack Lite Broadband Deployments Following IPv4
              Exhaustion", draft-ietf-softwire-dual-stack-lite-11 (work
              in progress), May 2011.



Despres, et al.         Expires December 18, 2011              [Page 14]

Internet-Draft          IPv4 Residual Deployment               June 2011


   [I-D.ietf-v6ops-tunnel-loops]
              Nakibly, G. and F. Templin, "Routing Loop Attack using
              IPv6 Automatic Tunnels: Problem Statement and Proposed
              Mitigations", draft-ietf-v6ops-tunnel-loops-07 (work in
              progress), May 2011.

   [I-D.operators-softwire-stateless-4v6-motivation]
              Boucadair, M., Matsushima, S., Lee, Y., Bonness, O.,
              Borges, I., and G. Chen, "Motivations for Stateless IPv4
              over IPv6 Migration Solutions",
              draft-operators-softwire-stateless-4v6-motivation-02 (work
              in progress), June 2011.

   [RFC2827]  Ferguson, P. and D. Senie, "Network Ingress Filtering:
              Defeating Denial of Service Attacks which employ IP Source
              Address Spoofing", BCP 38, RFC 2827, May 2000.

   [RFC3022]  Srisuresh, P. and K. Egevang, "Traditional IP Network
              Address Translator (Traditional NAT)", RFC 3022,
              January 2001.

   [RFC4953]  Touch, J., "Defending TCP Against Spoofing Attacks",
              RFC 4953, July 2007.

   [RFC5961]  Ramaiah, A., Stewart, R., and M. Dalal, "Improving TCP's
              Robustness to Blind In-Window Attacks", RFC 5961,
              August 2010.

   [RFC5969]  Townsley, W. and O. Troan, "IPv6 Rapid Deployment on IPv4
              Infrastructures (6rd) -- Protocol Specification",
              RFC 5969, August 2010.

   [RFC6056]  Larsen, M. and F. Gont, "Recommendations for Transport-
              Protocol Port Randomization", BCP 156, RFC 6056,
              January 2011.


Authors' Addresses

   Remi Despres
   RD-IPtech
   3 rue du President Wilson
   Levallois
   France

   Email: remi.despres@free.fr





Despres, et al.         Expires December 18, 2011              [Page 15]

Internet-Draft          IPv4 Residual Deployment               June 2011


   Tetsuya Murakami
   IP Infusion
   1188 East Arques Avenue
   Sunnyvale
   USA

   Email: tetsuya@ipinfusion.com


   Satoru Matsushima
   SoftBank
   1-9-1 Higashi-Shinbashi, Munato-ku
   Tokyo
   Japan

   Email: satoru.matsushima@tm.softbank.co.jp


   Ole Troan
   cisco
   Oslo
   Norway

   Email: ot@cisco.com



























Despres, et al.         Expires December 18, 2011              [Page 16]

